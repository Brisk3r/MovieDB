<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Media Library</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light text */
        }
        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for the search input */
        .search-input:focus {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        /* Custom styles for filter buttons */
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Responsive video container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            width: 100%;
            background-color: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-white mb-2">Family Media Library</h1>
            <p class="text-lg text-gray-400">A searchable, filterable collection of our favourite media.</p>
            <p class="text-sm text-gray-500 mt-2">Last Updated: <span id="last-updated" class="font-semibold">Never</span></p>
        </header>

        <!-- Search Input -->
        <div class="mb-6 max-w-2xl mx-auto">
            <input type="text" id="searchInput" placeholder="Search by title, director, creator, genre..."
                   class="search-input w-full px-4 py-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white placeholder-gray-500 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <!-- Filter and Sort Section -->
        <div class="flex flex-col justify-center items-center gap-4 mb-8">
            <!-- Type Filter Buttons -->
            <div id="type-filter-buttons" class="flex flex-wrap justify-center gap-2">
                <!-- Type filter buttons will be generated here by JS -->
            </div>
            <!-- Genre Filter Buttons -->
            <div id="genre-filter-buttons" class="flex flex-wrap justify-center gap-2 border-t border-gray-700 pt-4 mt-4 w-full max-w-4xl mx-auto">
                <!-- Genre filter buttons will be generated here by JS -->
            </div>
            <div class="flex flex-wrap justify-center items-center gap-4 mt-4">
                <!-- Sort Dropdown -->
                <div class="relative">
                    <select id="sort-select" class="appearance-none bg-gray-800 border-2 border-gray-700 rounded-lg py-2 px-4 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="default">Sort by...</option>
                        <option value="title-asc">Title (A-Z)</option>
                        <option value="title-desc">Title (Z-A)</option>
                        <option value="year-desc">Year (Newest)</option>
                        <option value="year-asc">Year (Oldest)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>
                 <!-- Reset Button -->
                <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <i class="fa-solid fa-rotate-right mr-2"></i>Reset
                </button>
            </div>
        </div>

        <!-- Media Container -->
        <div id="media-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Media cards will be injected here -->
        </div>
        
        <!-- Message for no results -->
        <div id="no-results" class="hidden text-center py-16">
             <p class="text-xl text-gray-500">No media found matching your criteria.</p>
        </div>

    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modal-content" class="modal-content bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl max-h-full overflow-y-auto relative scale-95">
            <!-- Modal content will be populated by JS -->
        </div>
    </div>

    <!-- Trailer Modal -->
    <div id="trailer-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[60] hidden opacity-0">
        <div class="w-full max-w-4xl relative">
             <button id="close-trailer-btn" class="absolute -top-10 right-0 text-white hover:text-red-500 text-3xl z-10">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div id="trailer-video-container" class="video-container rounded-lg overflow-hidden shadow-2xl">
                <!-- YouTube Iframe will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpSN6K4wy6t82cGVA7RYv3z0ZdSdnfiubeeSMRYMT5wOEKpCiComv_vPOX0mov5c6-DCj4Yg9UsiE-/pub?output=csv';

        // --- DOM ELEMENTS ---
        const mediaContainer = document.getElementById('media-container');
        const searchInput = document.getElementById('searchInput');
        const noResultsMessage = document.getElementById('no-results');
        const typeFilterButtonsContainer = document.getElementById('type-filter-buttons');
        const genreFilterButtonsContainer = document.getElementById('genre-filter-buttons');
        const sortSelect = document.getElementById('sort-select');
        const resetButton = document.getElementById('reset-button');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const detailsModal = document.getElementById('details-modal');
        const modalContent = document.getElementById('modal-content');
        const trailerModal = document.getElementById('trailer-modal');
        const trailerVideoContainer = document.getElementById('trailer-video-container');
        
        // --- GLOBAL STATE ---
        let allMediaData = []; // To store the original fetched data
        let currentTypeFilter = 'All'; // To track the active type filter
        let currentGenreFilter = 'All'; // To track the active genre filter
        let currentSort = 'default'; // To track the active sort option

        // --- FUNCTIONS ---

        /**
         * A more robust CSV parser that handles quoted fields.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const row = [];
                let currentField = '';
                let inQuotedField = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"' && (j === 0 || lines[i][j - 1] !== '\\')) {
                        inQuotedField = !inQuotedField;
                    } else if (char === ',' && !inQuotedField) {
                        row.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim());

                if (row.length === headers.length) {
                    const entry = {};
                    headers.forEach((header, index) => {
                        let value = row[index];
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.substring(1, value.length - 1);
                        }
                        entry[header] = value.replace(/""/g, '"');
                    });
                    data.push(entry);
                }
            }
            return data;
        }

        /**
         * Renders the media items to the page.
         */
        function renderMedia(mediaItems) {
            mediaContainer.innerHTML = ''; 
            noResultsMessage.classList.toggle('hidden', mediaItems.length === 0);

            mediaItems.forEach(item => {
                const posterUrl = item['Poster Link'] || '';
                const cardElement = document.createElement('div');
                cardElement.addEventListener('click', () => showDetailsModal(item));

                if (posterUrl) {
                    // --- POSTER-BASED CARD ---
                    cardElement.className = 'group relative aspect-[2/3] bg-gray-900 rounded-lg overflow-hidden shadow-lg transition-all duration-300 ease-in-out cursor-pointer hover:scale-105 hover:shadow-2xl';
                    const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodeURIComponent(item.Title || '').replace(/'/g, '%27')}`;
                    
                    cardElement.innerHTML = `
                        <img src="${posterUrl}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="Poster for ${item.Title}" class="w-full h-full object-cover transition-all duration-300 group-hover:brightness-50">
                        <div class="absolute inset-0 p-4 flex flex-col justify-end bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <h2 class="text-xl font-bold text-white mb-1">${item.Title || 'Untitled'}</h2>
                            <p class="text-sm text-gray-300">${item.Year || ''}</p>
                        </div>
                    `;
                } else {
                    // --- FALLBACK TEXT-BASED CARD ---
                    cardElement.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 ease-in-out flex flex-col cursor-pointer';
                    const typeColor = {'Movie': 'bg-indigo-900/50', 'Book': 'bg-emerald-900/50', 'TV Show': 'bg-sky-900/50', 'Video Game': 'bg-rose-900/50', 'default': 'bg-gray-800'}[item.Type] || 'bg-gray-800';
                    let creatorLabel = 'Creator';
                    let creatorName = item.Creator || 'Unknown';
                    if (item.Type && item.Type.toLowerCase() === 'movie') {
                        creatorLabel = 'Director(s)';
                        creatorName = item['Director(s)'] || item['Director'] || item.Creator || 'Unknown';
                    } else if (item.Type && item.Type.toLowerCase() === 'book') {
                        creatorLabel = 'Author';
                    }
                    cardElement.innerHTML = `
                        <div class="p-5 flex-grow flex flex-col justify-center">
                            <h2 class="text-xl font-bold text-white mb-2 flex-grow">${item.Title || 'Untitled'}</h2>
                            <p class="text-gray-400 mb-1"><span class="font-semibold">${creatorLabel}:</span> ${creatorName}</p>
                            <div class="mt-4 flex flex-wrap gap-2">
                                ${item.Genre ? `<span class="text-xs font-semibold text-gray-300 bg-gray-700 px-2 py-1 rounded-full">${item.Genre}</span>` : ''}
                                ${item.Year ? `<span class="text-xs font-semibold text-gray-300 bg-gray-700 px-2 py-1 rounded-full">${item.Year}</span>` : ''}
                            </div>
                        </div>
                        <div class="px-5 py-3 ${typeColor}"><p class="text-sm font-semibold text-white">${item.Type || 'Media'}</p></div>
                    `;
                }
                mediaContainer.appendChild(cardElement);
            });
        }
        
        /**
         * Shows the details modal with information for the selected item.
         */
        function showDetailsModal(item) {
            const posterUrl = item['Poster Link'] || '';
            const encodedTitle = encodeURIComponent(item.Title || '').replace(/'/g, '%27');
            const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodedTitle}`;
            
            let creatorLabel = 'Creator';
            let creatorName = item.Creator || 'Unknown';
            if (item.Type && item.Type.toLowerCase() === 'movie') {
                creatorLabel = 'Director(s)';
                creatorName = item['Director(s)'] || item['Director'] || item.Creator || 'Unknown';
            } else if (item.Type && item.Type.toLowerCase() === 'book') {
                creatorLabel = 'Author';
            }

            modalContent.innerHTML = `
                <button id="close-details-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10"><i class="fa-solid fa-xmark"></i></button>
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-1/3 p-4">
                        <img src="${posterUrl}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="Poster for ${item.Title}" class="w-full h-auto rounded-lg shadow-lg">
                    </div>
                    <div class="md:w-2/3 p-6 flex flex-col">
                        <h2 class="text-3xl font-bold text-white mb-2">${item.Title} (${item.Year || 'N/A'})</h2>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-gray-400 mb-4">
                            ${item.Type ? `<span><i class="fa-solid fa-film mr-2"></i>${item.Type}</span>` : ''}
                            ${item.Genre ? `<span><i class="fa-solid fa-tag mr-2"></i>${item.Genre}</span>` : ''}
                            ${item['Audience Rating'] ? `<span><i class="fa-solid fa-star mr-2"></i>${item['Audience Rating']}</span>` : ''}
                            ${item.Country ? `<span><i class="fa-solid fa-flag mr-2"></i>${item.Country}</span>` : ''}
                        </div>
                        <div class="space-y-2 text-lg mb-4">
                            <p><span class="font-semibold">${creatorLabel}:</span> ${creatorName}</p>
                            ${item['Writer(s)'] ? `<p><span class="font-semibold">Writer(s):</span> ${item['Writer(s)']}</p>` : ''}
                            ${item['Actor(s)'] ? `<p><span class="font-semibold">Actor(s):</span> ${item['Actor(s)']}</p>` : ''}
                        </div>
                        <div class="text-gray-300 flex-grow mb-4">
                            <h3 class="font-semibold text-white text-xl mb-2">Summary</h3>
                            <p>${item['Summary'] || 'No summary available.'}</p>
                        </div>
                        ${item['Trailer Link'] ? `<button id="view-trailer-btn" class="mt-auto inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-center w-full"><i class="fa-brands fa-youtube mr-2"></i>View Trailer</button>` : ''}
                    </div>
                </div>
            `;
            
            document.body.style.overflow = 'hidden';
            detailsModal.classList.remove('hidden');
            setTimeout(() => {
                detailsModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);

            document.getElementById('close-details-btn').addEventListener('click', hideDetailsModal);
            const trailerButton = document.getElementById('view-trailer-btn');
            if (trailerButton) {
                trailerButton.addEventListener('click', () => showTrailerModal(item['Trailer Link']));
            }
        }

        function hideDetailsModal() {
            document.body.style.overflow = '';
            detailsModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => detailsModal.classList.add('hidden'), 250);
        }

        function getYoutubeVideoId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function showTrailerModal(trailerUrl) {
            const videoId = getYoutubeVideoId(trailerUrl);
            if (!videoId) {
                alert('Invalid YouTube URL provided.');
                return;
            }
            trailerVideoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            trailerModal.classList.remove('hidden');
            setTimeout(() => trailerModal.classList.remove('opacity-0'), 10);
        }

        function hideTrailerModal() {
            trailerModal.classList.add('opacity-0');
            setTimeout(() => {
                trailerModal.classList.add('hidden');
                trailerVideoContainer.innerHTML = '';
            }, 250);
        }

        function generateTypeFilterButtons() {
            const types = ['All', ...new Set(allMediaData.map(item => item.Type).filter(Boolean).sort())];
            typeFilterButtonsContainer.innerHTML = types.map(type => `
                <button class="filter-btn px-4 py-2 bg-gray-700 text-gray-300 rounded-lg ${type === 'All' ? 'active' : ''}" data-type-filter="${type}">
                    ${type}
                </button>
            `).join('');

            typeFilterButtonsContainer.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', () => {
                    currentTypeFilter = button.dataset.typeFilter;
                    applyFiltersAndSort();
                });
            });
        }

        function generateGenreFilterButtons() {
            const allGenres = new Set();
            allMediaData.forEach(item => {
                if (item.Genre) {
                    item.Genre.split(',').forEach(genre => {
                        if (genre.trim()) allGenres.add(genre.trim());
                    });
                }
            });

            const sortedGenres = ['All', ...Array.from(allGenres).sort()];
            genreFilterButtonsContainer.innerHTML = sortedGenres.map(genre => `
                <button class="filter-btn px-3 py-1 bg-gray-600 text-gray-300 rounded-full text-sm ${genre === 'All' ? 'active' : ''}" data-genre-filter="${genre}">
                    ${genre}
                </button>
            `).join('');

            genreFilterButtonsContainer.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', () => {
                    currentGenreFilter = button.dataset.genreFilter;
                    applyFiltersAndSort();
                });
            });
        }

        function applyFiltersAndSort() {
            let processedData = [...allMediaData];
            const searchTerm = searchInput.value.toLowerCase();
            if (searchTerm) {
                processedData = processedData.filter(item => Object.values(item).some(value => String(value).toLowerCase().includes(searchTerm)));
            }

            if (currentTypeFilter !== 'All') {
                processedData = processedData.filter(item => item.Type === currentTypeFilter);
            }

            if (currentGenreFilter !== 'All') {
                processedData = processedData.filter(item => item.Genre && item.Genre.split(',').map(g => g.trim()).includes(currentGenreFilter));
            }
            
            typeFilterButtonsContainer.querySelectorAll('.filter-btn').forEach(button => button.classList.toggle('active', button.dataset.typeFilter === currentTypeFilter));
            genreFilterButtonsContainer.querySelectorAll('.filter-btn').forEach(button => button.classList.toggle('active', button.dataset.genreFilter === currentGenreFilter));

            switch (currentSort) {
                case 'title-asc':
                    processedData.sort((a, b) => (a.Title || '').localeCompare(b.Title || ''));
                    break;
                case 'title-desc':
                    processedData.sort((a, b) => (b.Title || '').localeCompare(a.Title || ''));
                    break;
                case 'year-desc':
                    processedData.sort((a, b) => (b.Year || 0) - (a.Year || 0));
                    break;
                case 'year-asc':
                    processedData.sort((a, b) => (a.Year || 0) - (b.Year || 0));
                    break;
            }
            
            renderMedia(processedData);
        }

        function resetAll() {
            searchInput.value = '';
            sortSelect.value = 'default';
            currentTypeFilter = 'All';
            currentGenreFilter = 'All';
            currentSort = 'default';
            applyFiltersAndSort();
        }

        async function initialize() {
            mediaContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Fetching media data...</p>';
            try {
                const cacheBustingUrl = `${CSV_URL}&_=${new Date().getTime()}`;
                const response = await fetch(cacheBustingUrl);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                
                const csvText = await response.text();
                allMediaData = parseCSV(csvText);
                
                lastUpdatedSpan.textContent = new Date().toLocaleString('en-AU', { dateStyle: 'medium', timeStyle: 'short' });

                generateTypeFilterButtons();
                generateGenreFilterButtons();
                applyFiltersAndSort();

            } catch (error) {
                console.error('Failed to fetch or parse media data:', error);
                mediaContainer.innerHTML = `<p class="text-red-400 col-span-full text-center">Error: Could not load media data. The source may be unavailable or blocked. Please check the console for details.</p>`;
                lastUpdatedSpan.textContent = 'Failed to load';
            }
        }

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('keyup', applyFiltersAndSort);
        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            applyFiltersAndSort();
        });
        resetButton.addEventListener('click', resetAll);
        detailsModal.addEventListener('click', (e) => {
            if (e.target === detailsModal) hideDetailsModal();
        });
        document.getElementById('close-trailer-btn').addEventListener('click', hideTrailerModal);
        trailerModal.addEventListener('click', (e) => {
            if (e.target === trailerModal) hideTrailerModal();
        });
        
        document.addEventListener('DOMContentLoaded', initialize);

    </script>

</body>
</html>
