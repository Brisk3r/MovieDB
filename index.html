<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark theme, JS will override -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grand Kumacho Library</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- noUiSlider for the range slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for inputs and selects */
        .control-element {
            transition: all 0.2s ease-in-out;
        }
        .control-element:focus {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
            outline: none;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Responsive video container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            width: 100%;
            background-color: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* --- Featured Slider Styles --- */
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .slider-track {
            animation: scroll 60s linear infinite;
            will-change: transform;
        }
        .slider-container:hover .slider-track {
            animation-play-state: paused;
        }
        /* --- noUiSlider Custom Styles --- */
        .noUi-target {
            background: #e2e8f0;
            border-radius: 9999px;
            border: none;
            box-shadow: none;
            height: 0.75rem;
        }
        .dark .noUi-target {
            background: #374151;
        }
        .noUi-connect {
            background: #3b82f6;
        }
        .noUi-handle {
            width: 1rem !important;
            height: 1rem !important;
            right: -0.5rem !important;
            top: -0.125rem !important;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: grab;
        }
        .dark .noUi-handle {
            border-color: #1f2937;
        }
        .noUi-handle:focus {
            outline: none;
        }
        .noUi-handle:active {
            cursor: grabbing;
        }
        .noUi-handle::before, .noUi-handle::after {
            display: none;
        }
        /* --- Randomizer Highlight --- */
        .slider-highlight {
            box-shadow: 0 0 0 4px #3b82f6 !important;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-slate-200 antialiased overflow-x-hidden">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header Section -->
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl sm:text-5xl font-bold text-slate-900 dark:text-white mb-2">The Grand Kumacho Library</h1>
            <p class="text-lg text-slate-600 dark:text-gray-400">A searchable, filterable collection of our favourite media.</p>
            <p class="text-sm text-slate-500 dark:text-gray-500 mt-2">Last Updated: <span id="last-updated" class="font-semibold">Never</span></p>
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full text-slate-500 dark:text-gray-400 hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors">
                <i class="fa-solid fa-sun" id="theme-toggle-sun"></i>
                <i class="fa-solid fa-moon hidden" id="theme-toggle-moon"></i>
            </button>
        </header>

        <!-- Featured Slider Section -->
        <div id="featured-slider" class="w-full mb-12 hidden">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4 text-center">Featured Movies & Shows</h2>
            <div class="slider-container w-full overflow-hidden relative h-64 py-4">
                <div id="slider-track" class="slider-track flex absolute top-0 left-0 h-full">
                    <!-- Slider items will be injected here -->
                </div>
                 <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-1 h-full bg-blue-500/50 rounded-full z-10 opacity-0" id="selection-indicator"></div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4 items-center">
            <!-- Search Input -->
            <div class="w-full">
                <input type="text" id="searchInput" placeholder="Search collection..." class="control-element w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-700 text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-gray-500">
            </div>
            <!-- Filter Dropdowns -->
            <select id="type-filter" class="control-element w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-700 text-slate-900 dark:text-white"></select>
            <select id="genre-filter" class="control-element w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-700 text-slate-900 dark:text-white"></select>
        </div>
        <!-- Second row of controls -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 items-center">
             <!-- Year Range Slider -->
            <div class="w-full px-2">
                <div id="year-slider"></div>
                <div class="flex justify-between text-sm text-slate-600 dark:text-gray-400 mt-2">
                    <span id="year-range-label-start"></span>
                    <span id="year-range-label-end"></span>
                </div>
            </div>
            <!-- Sort, Random, and Reset -->
            <div class="flex gap-4 w-full">
                <select id="sort-select" class="control-element w-full px-4 py-2 rounded-lg bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-700 text-slate-900 dark:text-white">
                    <option value="default">Sort By</option>
                    <option value="title-asc">Title (A-Z)</option>
                    <option value="title-desc">Title (Z-A)</option>
                    <option value="year-desc">Year (Newest)</option>
                    <option value="year-asc">Year (Oldest)</option>
                </select>
                <button id="dashboard-button" title="View Dashboard" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2.5 rounded-lg transition-colors">
                    <i class="fa-solid fa-chart-line"></i>
                </button>
                <button id="random-pick-button" title="Pick for me!" class="bg-green-600 hover:bg-green-700 text-white font-bold p-2.5 rounded-lg transition-colors">
                    <i class="fa-solid fa-dice"></i>
                </button>
                <button id="reset-button" title="Reset Filters" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2.5 rounded-lg transition-colors">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>


        <!-- Media Container -->
        <div id="media-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Media cards will be injected here -->
        </div>
        
        <!-- Message for no results -->
        <div id="no-results" class="hidden text-center py-16">
             <p class="text-xl text-slate-500 dark:text-gray-500">No media found matching your criteria.</p>
        </div>

    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modal-content" class="modal-content bg-slate-100 dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl max-h-full overflow-y-auto relative scale-95"></div>
    </div>

    <!-- Trailer Modal -->
    <div id="trailer-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[60] hidden opacity-0">
        <div class="w-full max-w-4xl relative">
             <button id="close-trailer-btn" class="absolute -top-10 right-0 text-white hover:text-red-500 text-3xl z-10"><i class="fa-solid fa-xmark"></i></button>
            <div id="trailer-video-container" class="video-container rounded-lg overflow-hidden shadow-2xl"></div>
        </div>
    </div>
    
    <!-- Dashboard Modal -->
    <div id="dashboard-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-slate-100 dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-y-auto relative scale-95 p-6">
            <button id="close-dashboard-btn" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white text-2xl z-10"><i class="fa-solid fa-xmark"></i></button>
            <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-6 text-center">Library Dashboard</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg mb-2 text-center">Media by Type</h3>
                    <canvas id="type-chart"></canvas>
                </div>
                <div class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg mb-2 text-center">Top 10 Genres</h3>
                    <canvas id="genre-chart"></canvas>
                </div>
                <div class="lg:col-span-2 bg-white dark:bg-gray-900 p-4 rounded-lg shadow">
                    <h3 class="font-bold text-lg mb-2 text-center">Collection by Decade</h3>
                    <canvas id="decade-chart"></canvas>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpSN6K4wy6t82cGVA7RYv3z0ZdSdnfiubeeSMRYMT5wOEKpCiComv_vPOX0mov5c6-DCj4Yg9UsiE-/pub?output=csv';
        const SLIDER_ITEM_COUNT = 20;

        // --- DOM ELEMENTS ---
        const mediaContainer = document.getElementById('media-container');
        const searchInput = document.getElementById('searchInput');
        const noResultsMessage = document.getElementById('no-results');
        const typeFilterDropdown = document.getElementById('type-filter');
        const genreFilterDropdown = document.getElementById('genre-filter');
        const sortSelect = document.getElementById('sort-select');
        const resetButton = document.getElementById('reset-button');
        const randomPickButton = document.getElementById('random-pick-button');
        const dashboardButton = document.getElementById('dashboard-button');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const detailsModal = document.getElementById('details-modal');
        const modalContent = document.getElementById('modal-content');
        const trailerModal = document.getElementById('trailer-modal');
        const trailerVideoContainer = document.getElementById('trailer-video-container');
        const dashboardModal = document.getElementById('dashboard-modal');
        const featuredSlider = document.getElementById('featured-slider');
        const sliderTrack = document.getElementById('slider-track');
        const themeToggleButton = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('theme-toggle-sun');
        const moonIcon = document.getElementById('theme-toggle-moon');
        const yearSlider = document.getElementById('year-slider');
        const yearRangeStartLabel = document.getElementById('year-range-label-start');
        const yearRangeEndLabel = document.getElementById('year-range-label-end');
        const selectionIndicator = document.getElementById('selection-indicator');
        
        // --- GLOBAL STATE ---
        let allMediaData = [];
        let yearRange = { min: 1900, max: new Date().getFullYear() };
        let isPickingRandom = false;
        let activeCharts = {};

        // --- FUNCTIONS ---

        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const row = [];
                let currentField = '';
                let inQuotedField = false;
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"' && (j === 0 || lines[i][j - 1] !== '\\')) {
                        inQuotedField = !inQuotedField;
                    } else if (char === ',' && !inQuotedField) {
                        row.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim());
                if (row.length === headers.length) {
                    const entry = {};
                    headers.forEach((header, index) => {
                        let value = row[index];
                        if (value.startsWith('"') && value.endsWith('"')) value = value.substring(1, value.length - 1);
                        entry[header] = value.replace(/""/g, '"');
                    });
                    data.push(entry);
                }
            }
            return data;
        }

        function renderMedia(mediaItems) {
            mediaContainer.innerHTML = ''; 
            noResultsMessage.classList.toggle('hidden', mediaItems.length === 0);
            mediaItems.forEach((item, index) => {
                const posterUrl = item['Poster Link'] || '';
                const cardElement = document.createElement('div');
                cardElement.dataset.index = index; // Add index for randomizer
                cardElement.addEventListener('click', () => {
                    if (!isPickingRandom) showDetailsModal(item);
                });
                
                if (posterUrl) {
                    cardElement.className = 'group relative aspect-[2/3] bg-gray-700 dark:bg-gray-900 rounded-lg overflow-hidden shadow-lg transition-all duration-300 ease-in-out cursor-pointer hover:scale-105 hover:shadow-2xl';
                    const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodeURIComponent(item.Title || '').replace(/'/g, '%27')}`;
                    cardElement.innerHTML = `
                        <img src="${posterUrl}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="Poster for ${item.Title}" class="w-full h-full object-cover transition-all duration-300 group-hover:brightness-50">
                        <div class="absolute inset-0 p-4 flex flex-col justify-end bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <h2 class="text-xl font-bold text-white mb-1">${item.Title || 'Untitled'}</h2>
                            <p class="text-sm text-gray-300">${item.Year || ''}</p>
                        </div>`;
                } else {
                    cardElement.className = 'bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 ease-in-out flex flex-col cursor-pointer aspect-[2/3]';
                    const typeColor = {'Movie': 'bg-indigo-100 dark:bg-indigo-900/50', 'Book': 'bg-emerald-100 dark:bg-emerald-900/50', 'TV Show': 'bg-sky-100 dark:bg-sky-900/50', 'Video Game': 'bg-rose-100 dark:bg-rose-900/50', 'default': 'bg-gray-200 dark:bg-gray-800'}[item.Type] || 'bg-gray-200 dark:bg-gray-800';
                    let creatorLabel = 'Creator';
                    let creatorName = item.Creator || 'Unknown';
                    if (item.Type?.toLowerCase() === 'movie') {
                        creatorLabel = 'Director(s)';
                        creatorName = item['Director(s)'] || item['Director'] || item.Creator || 'Unknown';
                    } else if (item.Type?.toLowerCase() === 'book') {
                        creatorLabel = 'Author';
                    }
                    cardElement.innerHTML = `
                        <div class="p-5 flex-grow flex flex-col justify-center">
                            <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-2 flex-grow">${item.Title || 'Untitled'}</h2>
                            <p class="text-slate-600 dark:text-gray-400 mb-1"><span class="font-semibold">${creatorLabel}:</span> ${creatorName}</p>
                            <div class="mt-4 flex flex-wrap gap-2">
                                ${item.Genre ? `<span class="text-xs font-semibold text-slate-700 dark:text-gray-300 bg-slate-200 dark:bg-gray-700 px-2 py-1 rounded-full">${item.Genre}</span>` : ''}
                                ${item.Year ? `<span class="text-xs font-semibold text-slate-700 dark:text-gray-300 bg-slate-200 dark:bg-gray-700 px-2 py-1 rounded-full">${item.Year}</span>` : ''}
                            </div>
                        </div>
                        <div class="px-5 py-3 ${typeColor}"><p class="text-sm font-semibold text-slate-800 dark:text-white">${item.Type || 'Media'}</p></div>`;
                }
                mediaContainer.appendChild(cardElement);
            });
        }
        
        function showDetailsModal(item) {
            const posterUrl = item['Poster Link'] || '';
            const encodedTitle = encodeURIComponent(item.Title || '').replace(/'/g, '%27');
            const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodedTitle}`;
            let creatorLabel = 'Creator';
            let creatorName = item.Creator || 'Unknown';
            if (item.Type?.toLowerCase() === 'movie') {
                creatorLabel = 'Director(s)';
                creatorName = item['Director(s)'] || item['Director'] || item.Creator || 'Unknown';
            } else if (item.Type?.toLowerCase() === 'book') {
                creatorLabel = 'Author';
            }
            modalContent.innerHTML = `
                <button id="close-details-btn" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-slate-900 dark:hover:text-white text-2xl z-10"><i class="fa-solid fa-xmark"></i></button>
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-1/3 p-4"><img src="${posterUrl}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="Poster for ${item.Title}" class="w-full h-auto rounded-lg shadow-lg"></div>
                    <div class="md:w-2/3 p-6 flex flex-col">
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-white mb-2">${item.Title} (${item.Year || 'N/A'})</h2>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-slate-600 dark:text-gray-400 mb-4">
                            ${item.Type ? `<span><i class="fa-solid fa-film mr-2"></i>${item.Type}</span>` : ''}
                            ${item.Genre ? `<span><i class="fa-solid fa-tag mr-2"></i>${item.Genre}</span>` : ''}
                            ${item['Audience Rating'] ? `<span><i class="fa-solid fa-star mr-2"></i>${item['Audience Rating']}</span>` : ''}
                            ${item.Country ? `<span><i class="fa-solid fa-flag mr-2"></i>${item.Country}</span>` : ''}
                        </div>
                        <div class="space-y-2 text-lg mb-4">
                            <p><span class="font-semibold">${creatorLabel}:</span> ${creatorName}</p>
                            ${item['Writer(s)'] ? `<p><span class="font-semibold">Writer(s):</span> ${item['Writer(s)']}</p>` : ''}
                            ${item['Actor(s)'] ? `<p><span class="font-semibold">Actor(s):</span> ${item['Actor(s)']}</p>` : ''}
                        </div>
                        <div class="text-slate-700 dark:text-gray-300 flex-grow mb-4"><h3 class="font-semibold text-slate-900 dark:text-white text-xl mb-2">Summary</h3><p>${item['Summary'] || 'No summary available.'}</p></div>
                        ${item['Trailer Link'] ? `<button id="view-trailer-btn" class="mt-auto inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-center w-full"><i class="fa-brands fa-youtube mr-2"></i>View Trailer</button>` : ''}
                    </div>
                </div>`;
            document.body.style.overflow = 'hidden';
            detailsModal.classList.remove('hidden');
            setTimeout(() => {
                detailsModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            document.getElementById('close-details-btn').addEventListener('click', hideDetailsModal);
            const trailerButton = document.getElementById('view-trailer-btn');
            if (trailerButton) trailerButton.addEventListener('click', () => showTrailerModal(item['Trailer Link']));
        }

        function hideDetailsModal() {
            document.body.style.overflow = '';
            detailsModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => detailsModal.classList.add('hidden'), 250);
        }

        function getYoutubeVideoId(url) {
            if (!url) return null;
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function showTrailerModal(trailerUrl) {
            const videoId = getYoutubeVideoId(trailerUrl);
            if (!videoId) { alert('Invalid YouTube URL provided.'); return; }
            trailerVideoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            trailerModal.classList.remove('hidden');
            setTimeout(() => trailerModal.classList.remove('opacity-0'), 10);
        }

        function hideTrailerModal() {
            trailerModal.classList.add('opacity-0');
            setTimeout(() => {
                trailerModal.classList.add('hidden');
                trailerVideoContainer.innerHTML = '';
            }, 250);
        }

        function populateFilterDropdown(element, getValues, label) {
            const values = ['All', ...new Set(getValues())].sort();
            element.innerHTML = `<option value="All">${label}</option>` + values.slice(1).map(value => `<option value="${value}">${value}</option>`).join('');
        }

        function populateFeaturedSlider(items) {
             if (!items) { // If no items passed, generate a new random set
                items = allMediaData
                    .filter(item => (item.Type?.toLowerCase() === 'movie' || item.Type?.toLowerCase() === 'tv show') && item['Poster Link'])
                    .sort(() => 0.5 - Math.random())
                    .slice(0, SLIDER_ITEM_COUNT);
            }

            if (items.length < 5) {
                featuredSlider.classList.add('hidden');
                return [];
            }

            featuredSlider.classList.remove('hidden');
            sliderTrack.innerHTML = ''; // Clear previous items
            sliderTrack.style.animation = 'none'; // Reset animation

            const createSliderItem = (item) => {
                const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodeURIComponent(item.Title || '').replace(/'/g, '%27')}`;
                const div = document.createElement('div');
                div.className = "flex-shrink-0 w-44 h-full mx-2 cursor-pointer group";
                div.innerHTML = `<img src="${item['Poster Link']}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="${item.Title}" class="w-full h-full object-cover rounded-lg transition-transform duration-300 group-hover:scale-105">`;
                div.addEventListener('click', () => {
                    if (!isPickingRandom) showDetailsModal(item);
                });
                return div;
            };

            items.forEach(item => sliderTrack.appendChild(createSliderItem(item)));
            items.forEach(item => sliderTrack.appendChild(createSliderItem(item))); // Duplicate for seamless loop
            
            // Restart CSS animation
            void sliderTrack.offsetWidth; // Trigger reflow
            sliderTrack.style.animation = `scroll ${items.length * 5}s linear infinite`;
            return items;
        }

        function initializeYearSlider() {
            const years = allMediaData.map(item => parseInt(item.Year)).filter(Boolean);
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            
            if (minYear === Infinity || maxYear === -Infinity) return; // No valid years

            yearRange = { min: minYear, max: maxYear };

            noUiSlider.create(yearSlider, {
                start: [minYear, maxYear],
                connect: true,
                step: 1,
                range: {
                    'min': minYear,
                    'max': maxYear
                },
                format: {
                    to: value => Math.round(value),
                    from: value => Number(value)
                }
            });

            yearSlider.noUiSlider.on('update', (values) => {
                yearRangeStartLabel.textContent = values[0];
                yearRangeEndLabel.textContent = values[1];
            });

            yearSlider.noUiSlider.on('change', () => {
                const values = yearSlider.noUiSlider.get();
                yearRange = { min: values[0], max: values[1] };
                applyFiltersAndSort();
            });
        }

        function applyFiltersAndSort() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeFilter = typeFilterDropdown.value;
            const genreFilter = genreFilterDropdown.value;
            
            let processedData = allMediaData
                .filter(item => searchTerm ? Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm)) : true)
                .filter(item => typeFilter !== 'All' ? item.Type === typeFilter : true)
                .filter(item => genreFilter !== 'All' ? item.Genre?.split(',').map(g => g.trim()).includes(genreFilter) : true)
                .filter(item => {
                    const itemYear = parseInt(item.Year);
                    if (!itemYear) return true; // Include items without a year
                    return itemYear >= yearRange.min && itemYear <= yearRange.max;
                });

            const sortValue = sortSelect.value;
            switch (sortValue) {
                case 'title-asc': processedData.sort((a, b) => (a.Title || '').localeCompare(b.Title || '')); break;
                case 'title-desc': processedData.sort((a, b) => (b.Title || '').localeCompare(a.Title || '')); break;
                case 'year-desc': processedData.sort((a, b) => (b.Year || 0) - (a.Year || 0)); break;
                case 'year-asc': processedData.sort((a, b) => (a.Year || 0) - (b.Year || 0)); break;
            }
            renderMedia(processedData);
        }

        function pickRandomMedia() {
            if (isPickingRandom) return;
            isPickingRandom = true;
            toggleControls(false);
            
            const featuredItems = populateFeaturedSlider();
            if (featuredItems.length === 0) {
                alert("No featured items to pick from!");
                isPickingRandom = false;
                toggleControls(true);
                return;
            }

            const finalItem = featuredItems[Math.floor(Math.random() * featuredItems.length)];
            const finalElement = Array.from(sliderTrack.children).find(el => el.querySelector('img').alt === finalItem.Title);

            sliderTrack.style.animation = 'none';
            selectionIndicator.classList.remove('opacity-0');

            const targetPosition = finalElement.offsetLeft - (sliderTrack.parentElement.offsetWidth / 2) + (finalElement.offsetWidth / 2);
            
            sliderTrack.style.transition = 'transform 3s cubic-bezier(0.25, 1, 0.5, 1)';
            sliderTrack.style.transform = `translateX(-${targetPosition}px)`;

            sliderTrack.addEventListener('transitionend', () => {
                finalElement.classList.add('slider-highlight');
                setTimeout(() => {
                    showDetailsModal(finalItem);
                    finalElement.classList.remove('slider-highlight');
                    selectionIndicator.classList.add('opacity-0');
                    sliderTrack.style.transition = ''; // Reset transition
                    isPickingRandom = false;
                    toggleControls(true);
                }, 800);
            }, { once: true });
        }

        function toggleControls(enabled) {
            const controls = [searchInput, typeFilterDropdown, genreFilterDropdown, sortSelect, resetButton, randomPickButton, dashboardButton];
            controls.forEach(control => {
                control.disabled = !enabled;
                control.style.cursor = enabled ? '' : 'not-allowed';
                control.style.opacity = enabled ? '1' : '0.5';
            });
        }

        function resetAll() {
            searchInput.value = '';
            typeFilterDropdown.value = 'All';
            genreFilterDropdown.value = 'All';
            sortSelect.value = 'default';
            if (yearSlider.noUiSlider) {
                yearSlider.noUiSlider.reset();
            }
            applyFiltersAndSort();
        }

        function handleThemeToggle() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            sunIcon.classList.toggle('hidden', isDark);
            moonIcon.classList.toggle('hidden', !isDark);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        function showDashboard() {
            document.body.style.overflow = 'hidden';
            dashboardModal.classList.remove('hidden');
            setTimeout(() => {
                dashboardModal.classList.remove('opacity-0');
                dashboardModal.querySelector('.modal-content').classList.remove('scale-95');
                renderCharts();
            }, 10);
        }

        function hideDashboard() {
            document.body.style.overflow = '';
            dashboardModal.classList.add('opacity-0');
            dashboardModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                dashboardModal.classList.add('hidden');
                Object.values(activeCharts).forEach(chart => chart.destroy());
                activeCharts = {};
            }, 250);
        }

        function renderCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? 'rgba(229, 231, 235, 0.9)' : 'rgba(31, 41, 55, 0.9)';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
            Chart.defaults.color = textColor;

            // Type Chart
            const typeCtx = document.getElementById('type-chart').getContext('2d');
            const typeCounts = allMediaData.reduce((acc, item) => {
                if(item.Type) acc[item.Type] = (acc[item.Type] || 0) + 1;
                return acc;
            }, {});
            if (activeCharts.type) activeCharts.type.destroy();
            activeCharts.type = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: ['#4f46e5', '#10b981', '#0ea5e9', '#f43f5e', '#6b7280', '#f97316', '#8b5cf6'],
                        borderColor: isDark ? '#1f2937' : '#f9fafb',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true }
            });

            // Genre Chart
            const genreCtx = document.getElementById('genre-chart').getContext('2d');
            const genreCounts = allMediaData.flatMap(item => item.Genre?.split(',') || []).map(g => g.trim()).filter(Boolean).reduce((acc, genre) => {
                acc[genre] = (acc[genre] || 0) + 1;
                return acc;
            }, {});
            const sortedGenres = Object.entries(genreCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (activeCharts.genre) activeCharts.genre.destroy();
            activeCharts.genre = new Chart(genreCtx, {
                type: 'bar',
                data: {
                    labels: sortedGenres.map(g => g[0]),
                    datasets: [{
                        label: 'Count',
                        data: sortedGenres.map(g => g[1]),
                        backgroundColor: '#3b82f6',
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: gridColor } }, y: { grid: { color: gridColor } } } }
            });

            // Decade Chart
            const decadeCtx = document.getElementById('decade-chart').getContext('2d');
            const decadeCounts = allMediaData.reduce((acc, item) => {
                if (item.Year && !isNaN(item.Year)) {
                    const decade = Math.floor(item.Year / 10) * 10;
                    acc[decade] = (acc[decade] || 0) + 1;
                }
                return acc;
            }, {});
            const sortedDecades = Object.entries(decadeCounts).sort((a, b) => a[0] - b[0]);
            if (activeCharts.decade) activeCharts.decade.destroy();
            activeCharts.decade = new Chart(decadeCtx, {
                type: 'line',
                data: {
                    labels: sortedDecades.map(d => `${d[0]}s`),
                    datasets: [{
                        label: 'Media Count',
                        data: sortedDecades.map(d => d[1]),
                        fill: true,
                        borderColor: '#16a34a',
                        backgroundColor: isDark ? 'rgba(22, 163, 74, 0.2)' : 'rgba(22, 163, 74, 0.1)',
                        tension: 0.1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: gridColor } }, y: { grid: { color: gridColor } } } }
            });
        }

        async function initialize() {
            mediaContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Fetching media data...</p>';
            try {
                const response = await fetch(`${CSV_URL}&_=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                const csvText = await response.text();
                allMediaData = parseCSV(csvText);
                
                populateFilterDropdown(typeFilterDropdown, () => allMediaData.map(item => item.Type).filter(Boolean), 'All Types');
                populateFilterDropdown(genreFilterDropdown, () => allMediaData.flatMap(item => item.Genre?.split(',') || []).map(g => g.trim()).filter(Boolean), 'All Genres');
                initializeYearSlider();
                populateFeaturedSlider();
                
                lastUpdatedSpan.textContent = new Date().toLocaleString('en-AU', { dateStyle: 'medium', timeStyle: 'short' });
                applyFiltersAndSort();
            } catch (error)
            {
                console.error('Failed to fetch or parse media data:', error);
                mediaContainer.innerHTML = `<p class="text-red-400 col-span-full text-center">Error: Could not load media data. Please check the console for details.</p>`;
                lastUpdatedSpan.textContent = 'Failed to load';
            }
        }

        // --- EVENT LISTENERS ---
        [searchInput, typeFilterDropdown, genreFilterDropdown, sortSelect].forEach(el => el.addEventListener('input', applyFiltersAndSort));
        resetButton.addEventListener('click', resetAll);
        randomPickButton.addEventListener('click', pickRandomMedia);
        dashboardButton.addEventListener('click', showDashboard);
        document.getElementById('close-dashboard-btn').addEventListener('click', hideDashboard);
        detailsModal.addEventListener('click', e => { if (e.target === detailsModal) hideDetailsModal(); });
        document.getElementById('close-trailer-btn').addEventListener('click', hideTrailerModal);
        trailerModal.addEventListener('click', e => { if (e.target === trailerModal) hideTrailerModal(); });
        themeToggleButton.addEventListener('click', handleThemeToggle);
        
        loadTheme(); // Load theme on initial page load
        document.addEventListener('DOMContentLoaded', initialize);

    </script>

</body>
</html>
