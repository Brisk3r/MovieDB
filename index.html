<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kumacho Movie App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container {
            max-height: 50vh; /* Adjusted for pagination */
            overflow-y: auto;
        }
        th, td {
            padding: 0.75rem;
            text-align: left; 
            border-bottom-width: 1px;
        }
        th {
            background-color: #f3f4f6; /* bg-gray-100 */
            position: sticky;
            top: 0;
            z-index: 10; 
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #searchInput:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); 
        }
        .clickable-title {
            color: #4f46e5; 
            text-decoration: underline;
            cursor: pointer;
        }
        .clickable-title:hover {
            color: #3730a3; 
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
            z-index: 50; 
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 90vh; 
            overflow-y: auto;
        }
        #recommendationModal iframe {
            width: 100%;
            height: 70vh;
            border: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .faq-question {
            font-weight: 600; 
            color: #1f2937; 
            margin-top: 0.75rem; 
        }
        .faq-answer {
            color: #4b5563; 
            margin-bottom: 0.75rem; 
            font-size: 0.875rem; 
        }
        .pagination-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.15s ease-in-out;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600">Kumacho Movie App</h1>
            <p class="text-gray-600 mt-2">Browse and search your curated lists of Movies, TV Shows, Cartoons, and Anime.</p>
            <div class="mt-4 space-x-2">
                <button id="openRecommendationModalButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105">
                    Suggest a Recommendation
                </button>
                <button id="openFaqModalButton" class="bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105">
                    FAQ / Help
                </button>
            </div>
        </header>

        <div class="mb-6 flex flex-wrap justify-center gap-2 sm:gap-3">
            <button data-list="movies" class="list-btn bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105">Movies</button>
            <button data-list="tvshows" class="list-btn bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105">TV Shows</button>
            <button data-list="cartoons" class="list-btn bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105">Cartoons</button>
            <button data-list="anime" class="list-btn bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-105">Anime</button>
        </div>

        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="Search current list (e.g., title, genre, year)..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>

        <div id="listContainer" class="bg-white p-4 sm:p-6 rounded-xl shadow-xl">
            <h2 id="listTitle" class="text-2xl font-semibold mb-4 text-gray-700">Select a category to view</h2>
            <div class="table-container rounded-lg border border-gray-200">
                <table id="mediaTable" class="min-w-full divide-y divide-gray-200">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td id="initialMessageCell" class="text-center text-gray-500 py-4" colspan="4">No list selected. Please choose a category above.</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="paginationControls" class="mt-4 flex justify-between items-center">
                </div>
            <p id="itemCount" class="text-sm text-gray-500 mt-2 text-right"></p>
        </div>
    </div>

    <div id="detailsModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden p-4 opacity-0">
        <div class="modal-content relative mx-auto p-6 border w-full max-w-md shadow-xl rounded-xl bg-white transform scale-95 opacity-0">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h3 class="text-xl leading-6 font-medium text-gray-900" id="modalTitle">Item Details</h3>
                <button id="closeModalButton" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4"><div id="modalBody" class="text-sm text-gray-700 space-y-2"></div></div>
            <div class="mt-6 pt-3 border-t border-gray-200 text-right">
                <button id="modalCloseButtonFooter" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-lg shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Close</button>
            </div>
        </div>
    </div>
    <div id="recommendationModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden p-4 opacity-0">
        <div class="modal-content relative mx-auto p-6 border w-full max-w-2xl shadow-xl rounded-xl bg-white transform scale-95 opacity-0">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h3 class="text-xl leading-6 font-medium text-gray-900">Suggest a Recommendation</h3>
                <button id="closeRecommendationModalButton" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4"><iframe id="recommendationFormIframe" frameborder="0" marginheight="0" marginwidth="0">Loadingâ€¦</iframe></div>
            <div class="mt-6 pt-3 border-t border-gray-200 text-right">
                <button id="recommendationModalCloseButtonFooter" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-lg shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">Close</button>
            </div>
        </div>
    </div>
    <div id="faqModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden p-4 opacity-0">
        <div class="modal-content relative mx-auto p-6 border w-full max-w-lg shadow-xl rounded-xl bg-white transform scale-95 opacity-0">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200">
                <h3 class="text-xl leading-6 font-medium text-gray-900">FAQ / Help</h3>
                <button id="closeFaqModalButton" class="text-gray-400 hover:text-gray-600 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="faqModalBody" class="mt-4 space-y-4 text-left">
                <div>
                    <p class="faq-question">Why isn't data loading from the CSV links (e.g., "No movies found...")?</p>
                    <p class="faq-answer">This usually happens for one of these reasons:
                        <br>1. <strong>CORS Policy (if running locally):</strong> When you open this HTML file directly from your computer (`file:///...`), browsers block requests to external sites (like Google Sheets) for security.
                        <br>&nbsp;&nbsp;&nbsp;<strong>Solution:</strong> Run this HTML file through a local web server (e.g., using Python's `http.server`).
                        <br>2. <strong>Network Issue:</strong> Check your internet connection.
                        <br>3. <strong>CSV Link Incorrect/Private:</strong> Ensure your Google Sheet is "Published to the web" as a CSV, and "Anyone with the link can view." Double-check the link in the app's code.
                        <br>4. <strong>Empty or Malformed CSV:</strong> The CSV file itself might be empty or not formatted correctly. For the "Movies" list, the app expects a "Titles" header (or "Title", or will treat a single column of titles as headerless). For other lists, a header row is expected with the relevant column names.</p>
                </div>
                <div>
                    <p class="faq-question">Why does a pop-up sometimes just show a grey screen without content?</p>
                    <p class="faq-answer">This can be a browser rendering timing issue. The code tries to prevent this. If it happens, a page refresh might help. Also, ensure the data for the item you clicked is actually loading correctly.</p>
                </div>
            </div>
            <div class="mt-6 pt-3 border-t border-gray-200 text-right">
                <button id="faqModalCloseButtonFooter" class="px-4 py-2 bg-sky-500 text-white text-base font-medium rounded-lg shadow-sm hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const CSV_URLS = {
            movies: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTeW7g2d80vRYYW84HsaltNDkQgzvkfcSqUR3z-Z2W2AaKWVtSVJazBvfTnq3OXb0zZXcMapQJFCkZ9/pub?gid=0&single=true&output=csv",
            tvshows: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTeW7g2d80vRYYW84HsaltNDkQgzvkfcSqUR3z-Z2W2AaKWVtSVJazBvfTnq3OXb0zZXcMapQJFCkZ9/pub?gid=1290796578&single=true&output=csv",
            cartoons: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTeW7g2d80vRYYW84HsaltNDkQgzvkfcSqUR3z-Z2W2AaKWVtSVJazBvfTnq3OXb0zZXcMapQJFCkZ9/pub?gid=498269002&single=true&output=csv",
            anime: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTeW7g2d80vRYYW84HsaltNDkQgzvkfcSqUR3z-Z2W2AaKWVtSVJazBvfTnq3OXb0zZXcMapQJFCkZ9/pub?gid=743139865&single=true&output=csv"
        };
        const RECOMMENDATION_FORM_URL = "https://forms.gle/chLrCD4QxEE23SPa8";
        const ITEMS_PER_PAGE = 15;

        // --- App State ---
        let allDataCache = { movies: null, tvshows: null, cartoons: null, anime: null };
        let currentListType = null;
        let currentHeaders = [];
        let currentListTitle = 'No list selected';
        let currentPage = 1;
        let currentFilteredData = [];


        // --- DOM Elements ---
        const listButtons = document.querySelectorAll('.list-btn');
        const searchInput = document.getElementById('searchInput');
        const listTitleElement = document.getElementById('listTitle');
        const tableHeadElement = document.getElementById('tableHead');
        const tableBodyElement = document.getElementById('tableBody');
        const itemCountElement = document.getElementById('itemCount');
        const initialMessageCell = document.getElementById('initialMessageCell');
        const paginationControlsElement = document.getElementById('paginationControls');
        
        const detailsModal = document.getElementById('detailsModal');
        const detailsModalContent = detailsModal.querySelector('.modal-content');
        const modalTitleElement = document.getElementById('modalTitle');
        const modalBodyElement = document.getElementById('modalBody');
        
        const recommendationModal = document.getElementById('recommendationModal');
        const recommendationModalContent = recommendationModal.querySelector('.modal-content');
        const recommendationFormIframe = document.getElementById('recommendationFormIframe');

        const faqModal = document.getElementById('faqModal');
        const faqModalContent = faqModal.querySelector('.modal-content');

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            listButtons.forEach(button => {
                button.addEventListener('click', () => loadAndDisplayList(button.dataset.list, button));
            });
            searchInput.addEventListener('input', () => {
                currentPage = 1; // Reset to first page on new search
                renderTable();
            });

            [detailsModal.querySelector('#closeModalButton'), detailsModal.querySelector('#modalCloseButtonFooter')].forEach(btn => btn.addEventListener('click', hideDetailsModal));
            detailsModal.addEventListener('click', (event) => { if (event.target === detailsModal) hideDetailsModal(); });

            document.getElementById('openRecommendationModalButton').addEventListener('click', showRecommendationModal);
            [recommendationModal.querySelector('#closeRecommendationModalButton'), recommendationModal.querySelector('#recommendationModalCloseButtonFooter')].forEach(btn => btn.addEventListener('click', hideRecommendationModal));
            recommendationModal.addEventListener('click', (event) => { if (event.target === recommendationModal) hideRecommendationModal(); });
            
            document.getElementById('openFaqModalButton').addEventListener('click', showFaqModal);
            [faqModal.querySelector('#closeFaqModalButton'), faqModal.querySelector('#faqModalCloseButtonFooter')].forEach(btn => btn.addEventListener('click', hideFaqModal));
            faqModal.addEventListener('click', (event) => { if (event.target === faqModal) hideFaqModal(); });
        });

        // --- Core Functions ---
        async function fetchCSVData(url, listType) {
            console.log(`Fetching CSV from: ${url} for listType: ${listType}`);
            try {
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) {
                    const errorText = `HTTP error! Status: ${response.status}. URL: ${url}.`;
                    console.error(errorText);
                    if (window.location.protocol === "file:") {
                        console.warn("Fetching external resources from 'file://' protocol is often blocked by browser CORS policy. Try using a local web server.");
                    }
                    throw new Error(errorText);
                }
                const csvText = await response.text();
                console.log(`Successfully fetched CSV data from ${url}. Raw length: ${csvText.length}`);
                if (!csvText || csvText.trim() === "") {
                    console.warn(`CSV file from ${url} is empty or contains only whitespace.`);
                    return [];
                }
                return parseCSV(csvText, listType);
            } catch (error) {
                console.error("Error in fetchCSVData for " + url, error);
                tableHeadElement.innerHTML = '';
                tableBodyElement.innerHTML = `<tr><td colspan="1" class="text-center text-red-600 font-semibold py-4">Error loading data for ${currentListTitle}: ${error.message}. Check console, ensure CSV link is public & correctly outputs CSV, and verify network. If running locally, use a web server.</td></tr>`;
                itemCountElement.textContent = '';
                paginationControlsElement.innerHTML = '';
                return [];
            }
        }

        function parseCSV(csvText, listType) {
            console.log(`Parsing CSV for listType: ${listType}. First 100 chars: ${csvText.substring(0,100)}`);
            const lines = csvText.trim().split(/\r\n|\n/).filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                console.warn("CSV is effectively empty after trimming and filtering empty lines.");
                return [];
            }

            let csvHeadersFromActualFile;
            let dataLines;
            const isMovieList = listType === 'movies';

            const firstLineClean = lines[0].trim().replace(/^"|"$/g, '').toLowerCase();

            if (isMovieList) {
                // Check if the first line of the movie CSV is likely a header or just data
                // A simple check: if it's not 'titles' or 'title' and has no commas, assume headerless
                if (!firstLineClean.includes(',') && firstLineClean !== 'titles' && firstLineClean !== 'title') {
                    console.log("Movie list CSV assumed headerless (single column, first line not 'Titles'/'Title'). Using 'titles' as implicit key.");
                    csvHeadersFromActualFile = ['titles']; // This is the key we'll use for the data object
                    dataLines = lines;    // All lines are data
                } else {
                    console.log("Movie list CSV has a header row (expected 'Titles', 'Year', etc. OR just 'Titles' or 'Title').");
                    csvHeadersFromActualFile = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                    dataLines = lines.slice(1);
                }
            } else {
                if (lines.length < 1) { console.warn(`CSV for ${listType} has no header line.`); return []; }
                csvHeadersFromActualFile = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                dataLines = lines.slice(1);
            }
            
            console.log("Effective CSV Headers for parsing:", csvHeadersFromActualFile);
            const data = [];

            dataLines.forEach((line, lineIndex) => {
                if (!line.trim()) return;

                const values = [];
                let currentField = '';
                let inQuotes = false;
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        if (inQuotes && j + 1 < line.length && line[j+1] === '"') {
                            currentField += '"'; j++; 
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentField); currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                values.push(currentField); 

                if (values.length === csvHeadersFromActualFile.length) {
                    const rowObject = {};
                    csvHeadersFromActualFile.forEach((header, index) => {
                        let keyToUse = headerToKey(header);
                        // Ensure movie titles are stored under 'titles' key internally for consistency
                        if (isMovieList && (keyToUse === 'title' || csvHeadersFromActualFile.length === 1)) {
                           keyToUse = 'titles';
                        }
                        rowObject[keyToUse] = values[index].trim().replace(/^"|"$/g, '');
                    });
                    data.push(rowObject);
                } else {
                    const actualLineNumber = lineIndex + (isMovieList && csvHeadersFromActualFile[0] === 'titles' && dataLines === lines ? 1 : 2);
                    console.warn(`Skipping malformed CSV line ${actualLineNumber} for ${listType}: Expected ${csvHeadersFromActualFile.length} fields, got ${values.length}. Line: "${line}"`);
                }
            });
            console.log(`Parsed ${data.length} data rows for ${listType}. First item:`, data[0]);
            return data;
        }
        
        async function loadAndDisplayList(listType, buttonElement = null) {
            if (buttonElement) setActiveButton(buttonElement);
            currentListType = listType;
            currentPage = 1; // Reset to first page
            setTableLoadingState(true);
            itemCountElement.textContent = ''; 

            console.log(`Loading data for: ${listType}`);
            const data = await fetchCSVData(CSV_URLS[listType], listType); 
            allDataCache[currentListType] = data; 
            
            switch (listType) {
                case 'movies':
                    currentHeaders = ['Titles']; 
                    currentListTitle = 'Movies';
                    break;
                case 'tvshows':
                    currentHeaders = ['Title', 'Genre(s)', 'Years Aired'];
                    currentListTitle = 'TV Shows';
                    break;
                case 'cartoons':
                    currentHeaders = ['Title', 'Genre(s)', 'Years Aired', 'Country of Origin'];
                    currentListTitle = 'Cartoons';
                    break;
                case 'anime':
                    currentHeaders = ['Title', 'Genre(s)', 'Years Aired', 'Content Rating'];
                    currentListTitle = 'Anime';
                    break;
            }
            setTableLoadingState(false); 
            renderTable(); 
        }
        
        function setTableLoadingState(isLoading) {
            if (isLoading) {
                tableHeadElement.innerHTML = '';
                tableBodyElement.innerHTML = `<tr><td colspan="1" class="text-center py-4"><div class="loader"></div><p class="text-gray-500">Loading data...</p></td></tr>`;
                paginationControlsElement.innerHTML = ''; // Clear pagination while loading
                if(initialMessageCell) initialMessageCell.style.display = 'none';
            } else {
                 if(initialMessageCell) initialMessageCell.style.display = 'none';
            }
        }

        function setActiveButton(activeBtn) {
            listButtons.forEach(btn => {
                btn.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500', 'ring-teal-500', 'ring-amber-500', 'ring-rose-500');
                if (btn === activeBtn) {
                    btn.classList.add('ring-2', 'ring-offset-2');
                    const listType = btn.dataset.list;
                    if (listType === 'movies') btn.classList.add('ring-indigo-500');
                    else if (listType === 'tvshows') btn.classList.add('ring-teal-500');
                    else if (listType === 'cartoons') btn.classList.add('ring-amber-500');
                    else if (listType === 'anime') btn.classList.add('ring-rose-500');
                }
            });
        }
        
        function renderTable() {
            listTitleElement.textContent = currentListTitle;
            tableHeadElement.innerHTML = '';
            tableBodyElement.innerHTML = ''; 
            itemCountElement.textContent = '';
            if(initialMessageCell) initialMessageCell.style.display = 'none';

            if (!currentListType) {
                tableBodyElement.innerHTML = `<tr><td class="text-center text-gray-500 py-4" colspan="1">Select a category to view.</td></tr>`;
                paginationControlsElement.innerHTML = '';
                return;
            }
            
            const dataForCurrentList = allDataCache[currentListType] || [];

            if (tableBodyElement.querySelector('.text-red-600')) {
                paginationControlsElement.innerHTML = '';
                return; 
            }

            const searchTerm = searchInput.value.toLowerCase();
            currentFilteredData = dataForCurrentList.filter(item => {
                if (!item || typeof item !== 'object') return false;
                if (!searchTerm) return true; 
                return Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchTerm)
                );
            });

            if (currentFilteredData.length === 0 && dataForCurrentList.length > 0 && searchTerm) {
                 const colSpan = currentHeaders.length > 0 ? currentHeaders.length : 1;
                tableBodyElement.innerHTML = `<tr><td colspan="${colSpan}" class="text-center text-gray-500 py-4">No items match your search.</td></tr>`;
                itemCountElement.textContent = `Showing 0 of ${dataForCurrentList.length} items.`;
                paginationControlsElement.innerHTML = '';
                return;
            }
            
            if (currentFilteredData.length === 0 && dataForCurrentList.length === 0) {
                 const colSpan = currentHeaders.length > 0 ? currentHeaders.length : 1;
                tableBodyElement.innerHTML = `<tr><td colspan="${colSpan}" class="text-center text-gray-500 py-4">No ${currentListTitle.toLowerCase()} data found. Ensure CSV is populated, public, correctly formatted, and the link is valid.</td></tr>`;
                paginationControlsElement.innerHTML = '';
                return;
            }
            
            const headerRow = tableHeadElement.insertRow();
            currentHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = headerText; 
                headerRow.appendChild(th);
            });
            
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedData = currentFilteredData.slice(startIndex, endIndex);

            if (paginatedData.length > 0) {
                paginatedData.forEach(item => {
                    if (!item || typeof item !== 'object') return; 
                    const row = tableBodyElement.insertRow();
                    currentHeaders.forEach(header => {
                        const cell = row.insertCell();
                        cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-700';
                        const key = headerToKey(header); 
                        const value = item[key] || '';
                        
                        if (header === currentHeaders[0]) { 
                            cell.textContent = value;
                            cell.classList.add('clickable-title');
                            cell.onclick = () => showItemDetails(item);
                        } else {
                            cell.textContent = value;
                        }
                    });
                });
            } else if (currentFilteredData.length > 0 && currentPage > 1) { // On a page with no items but there are items in total
                currentPage = 1; // Go back to first page
                renderTable(); // Re-render
                return;
            }
            
            itemCountElement.textContent = `Showing ${startIndex + 1}-${Math.min(endIndex, currentFilteredData.length)} of ${currentFilteredData.length} items. (Total in list: ${dataForCurrentList.length})`;
            renderPaginationControls();
        }

        function renderPaginationControls() {
            paginationControlsElement.innerHTML = '';
            if (!currentFilteredData || currentFilteredData.length === 0) return;

            const totalPages = Math.ceil(currentFilteredData.length / ITEMS_PER_PAGE);
            if (totalPages <= 1) return; // No need for controls if only one page

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.className = 'pagination-btn bg-gray-300 hover:bg-gray-400 text-gray-800';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            };

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.className = 'pagination-btn bg-indigo-500 hover:bg-indigo-600 text-white';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            };
            
            const pageInfo = document.createElement('span');
            pageInfo.className = 'text-sm text-gray-700';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

            paginationControlsElement.appendChild(prevButton);
            paginationControlsElement.appendChild(pageInfo);
            paginationControlsElement.appendChild(nextButton);
        }


        function headerToKey(headerText) {
            if (!headerText) return '';
            return headerText.toLowerCase().replace(/[^a-z0-9]/gi, '');
        }
        
        function showModal(modalElement, modalContentElement) {
            modalElement.classList.remove('hidden');
            requestAnimationFrame(() => { 
                modalElement.classList.remove('opacity-0');
                modalContentElement.classList.remove('opacity-0', 'scale-95');
                modalContentElement.classList.add('opacity-100', 'scale-100');
            });
        }

        function hideModal(modalElement, modalContentElement, onHideCallback) {
            modalContentElement.classList.add('opacity-0', 'scale-95');
            modalContentElement.classList.remove('opacity-100', 'scale-100');
            modalElement.classList.add('opacity-0');
            setTimeout(() => {
                 modalElement.classList.add('hidden');
                 if (onHideCallback) onHideCallback();
            }, 300); 
        }

        function showItemDetails(item) {
            const itemTitle = item.titles || item.title || "Details"; // Prioritize 'titles' for movies
            modalTitleElement.textContent = itemTitle;
            modalBodyElement.innerHTML = ''; 

            for (const key in item) {
                if (Object.hasOwnProperty.call(item, key)) {
                    const value = item[key] || 'N/A';
                    const detailP = document.createElement('p');
                    let displayName = key.replace(/([A-Z0-9])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    displayName = displayName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); 

                    detailP.innerHTML = `<strong class="font-semibold text-gray-600">${displayName}:</strong> ${value}`;
                    modalBodyElement.appendChild(detailP);
                }
            }
            showModal(detailsModal, detailsModalContent);
        }
        function hideDetailsModal() { hideModal(detailsModal, detailsModalContent); }

        function showRecommendationModal() {
            recommendationFormIframe.src = RECOMMENDATION_FORM_URL;
            showModal(recommendationModal, recommendationModalContent);
        }
        function hideRecommendationModal() { 
            hideModal(recommendationModal, recommendationModalContent, () => {
                recommendationFormIframe.src = "about:blank"; 
            });
        }

        function showFaqModal() { showModal(faqModal, faqModalContent); }
        function hideFaqModal() { hideModal(faqModal, faqModalContent); }

    </script>
</body>
</html>
```
I've updated the "Kumacho Movie App" on the Canvas with the pagination feature and further refinements for the movie list data handling.

Here's a summary of the changes:

1.  **Pagination Added**:
    * An `ITEMS_PER_PAGE` constant is set (defaulting to 15).
    * A `currentPage` state variable tracks the current page for the displayed list.
    * The `renderTable` function now slices the `currentFilteredData` to display only the items for the current page.
    * A new `renderPaginationControls` function is created:
        * It dynamically generates "Previous" and "Next" buttons.
        * It displays the current page number and total pages (e.g., "Page 2 of 5").
        * Buttons are disabled appropriately (e.g., "Previous" on the first page, "Next" on the last).
        * Clicking these buttons updates `currentPage` and re-renders the table and pagination controls.
    * The item count message now reflects the paginated view (e.g., "Showing 16-30 of 100 items").
    * When a new list is selected or a search term is entered, `currentPage` is reset to 1.

2.  **Movie List CSV Parsing (Further Refined)**:
    * The `parseCSV` function's logic for `isMovieList = true` (when `listType` is 'movies') has been further clarified:
        * It first checks if the very first line of the CSV (after cleaning) is exactly "titles" or "title" (case-insensitive) AND if there are no commas on that line. If both are true, it implies a single "Titles" or "Title" header for a single column of movie names.
        * If the above condition is NOT met (meaning the first line either contains commas indicating multiple headers, or it's not "Titles"/"Title" suggesting it's a headerless list of titles), it then checks if the first line contains *no commas at all*. If so, it assumes it's a headerless, single-column list of movie titles, and internally uses `['titles']` as the header key.
        * Otherwise (if the first line has commas and isn't just "Titles"/"Title"), it parses the first line as multiple headers (e.g., "Titles,Year,Director,Genre").
    * **Crucially, regardless of how the header is detected ("Titles", "Title", or headerless), the parsed movie objects will now consistently store the movie name under the `item.titles` property.** This is because `currentHeaders` for movies is set to `['Titles']`, and `headerToKey('Titles')` becomes `titles`. This standardization is key.

3.  **Search Logic Update**:
    * The search in `renderTable` now filters against *all* values in each item object (`Object.values(item).some(...)`). This means if your movie CSV has "Year", "Director", "Genre" columns, the search will include those fields even if they aren't displayed in the main table's single "Titles" column.

4.  **DOM Element Caching**: I've moved the `document.getElementById` calls for frequently accessed elements to the top level of the script (outside `DOMContentLoaded`) to cache them once, which is a minor performance optimization.

**Regarding the "Movies" tab still showing blank lines:**

With the refined parsing and consistent use of `item.titles`, this should be much more robust.
* **Please ensure your Movie CSV (gid=0) has "Titles" as the header in cell A1.** This is the most straightforward way for the app to understand it.
* If it's truly just a list of movie names starting from row 1, column A, with no header at all, the "headerless" logic should kick in and still work.
* **The key is that `renderTable` for movies expects to find data in `item.titles`.** The `parseCSV` function is now designed to ensure this happens.

When you test (especially with your local server):
* **Clear Browser Cache**: Sometimes browsers cache old versions of files or data. Try a hard refresh (Ctrl+Shift+R or Cmd+Shift+R) or clear your browser cache for `localhost`.
* **Check Console Logs**: Open the developer console (F12). I've added more `console.log` statements in `fetchCSVData` and `parseCSV` that will show:
    * The URL being fetched.
    * The raw length of the fetched CSV text.
    * The detected/effective headers for parsing.
    * The number of data rows parsed.
    * The first parsed item object.
    These logs will be invaluable if the movie list still doesn't populate, as they'll show exactly what the script is "seeing" from your CSV.

This version significantly overhauls the data handling and adds a major new feature (pagination). Hopefully, it resolves the movie list issue and provides a better user experien
