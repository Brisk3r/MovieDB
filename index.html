<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Media Library</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light text */
        }
        /* Custom scrollbar for a more modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for inputs and selects */
        .control-element {
            background-color: #1f2937;
            border: 1px solid #374151;
            transition: all 0.2s ease-in-out;
        }
        .control-element:focus {
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
            outline: none;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        /* Responsive video container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            width: 100%;
            background-color: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* --- Featured Slider Styles --- */
        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .slider-track {
            animation: scroll 60s linear infinite;
            will-change: transform;
        }
        .slider-container:hover .slider-track {
            animation-play-state: paused;
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-white mb-2">Family Media Library</h1>
            <p class="text-lg text-gray-400">A searchable, filterable collection of our favourite media.</p>
            <p class="text-sm text-gray-500 mt-2">Last Updated: <span id="last-updated" class="font-semibold">Never</span></p>
        </header>

        <!-- Featured Slider Section -->
        <div id="featured-slider" class="w-full mb-12 hidden">
            <h2 class="text-2xl font-bold text-white mb-4">Featured Movies & Shows</h2>
            <div class="slider-container w-full overflow-hidden relative h-64">
                <div id="slider-track" class="slider-track flex absolute top-0 left-0 h-full">
                    <!-- Slider items will be injected here -->
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8 items-center">
            <!-- Search Input -->
            <div class="lg:col-span-2">
                <input type="text" id="searchInput" placeholder="Search collection..." class="control-element w-full px-4 py-2 rounded-lg text-white placeholder-gray-500">
            </div>
            <!-- Filter Dropdowns -->
            <select id="type-filter" class="control-element w-full px-4 py-2 rounded-lg text-white"></select>
            <select id="genre-filter" class="control-element w-full px-4 py-2 rounded-lg text-white"></select>
            <!-- Sort and Reset -->
            <div class="flex gap-4 w-full">
                <select id="sort-select" class="control-element w-full px-4 py-2 rounded-lg text-white">
                    <option value="default">Sort By</option>
                    <option value="title-asc">Title (A-Z)</option>
                    <option value="title-desc">Title (Z-A)</option>
                    <option value="year-desc">Year (Newest)</option>
                    <option value="year-asc">Year (Oldest)</option>
                </select>
                <button id="reset-button" title="Reset Filters" class="bg-gray-600 hover:bg-gray-700 text-white font-bold p-2.5 rounded-lg transition-colors">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>

        <!-- Media Container -->
        <div id="media-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Media cards will be injected here -->
        </div>
        
        <!-- Message for no results -->
        <div id="no-results" class="hidden text-center py-16">
             <p class="text-xl text-gray-500">No media found matching your criteria.</p>
        </div>

    </div>

    <!-- Details Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modal-content" class="modal-content bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl max-h-full overflow-y-auto relative scale-95"></div>
    </div>

    <!-- Trailer Modal -->
    <div id="trailer-modal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-[60] hidden opacity-0">
        <div class="w-full max-w-4xl relative">
             <button id="close-trailer-btn" class="absolute -top-10 right-0 text-white hover:text-red-500 text-3xl z-10"><i class="fa-solid fa-xmark"></i></button>
            <div id="trailer-video-container" class="video-container rounded-lg overflow-hidden shadow-2xl"></div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpSN6K4wy6t82cGVA7RYv3z0ZdSdnfiubeeSMRYMT5wOEKpCiComv_vPOX0mov5c6-DCj4Yg9UsiE-/pub?output=csv';
        const SLIDER_ITEM_COUNT = 20;

        // --- DOM ELEMENTS ---
        const mediaContainer = document.getElementById('media-container');
        const searchInput = document.getElementById('searchInput');
        const noResultsMessage = document.getElementById('no-results');
        const typeFilterDropdown = document.getElementById('type-filter');
        const genreFilterDropdown = document.getElementById('genre-filter');
        const sortSelect = document.getElementById('sort-select');
        const resetButton = document.getElementById('reset-button');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const detailsModal = document.getElementById('details-modal');
        const modalContent = document.getElementById('modal-content');
        const trailerModal = document.getElementById('trailer-modal');
        const trailerVideoContainer = document.getElementById('trailer-video-container');
        const featuredSlider = document.getElementById('featured-slider');
        const sliderTrack = document.getElementById('slider-track');
        
        // --- GLOBAL STATE ---
        let allMediaData = [];

        // --- FUNCTIONS ---

        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const row = [];
                let currentField = '';
                let inQuotedField = false;
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"' && (j === 0 || lines[i][j - 1] !== '\\')) {
                        inQuotedField = !inQuotedField;
                    } else if (char === ',' && !inQuotedField) {
                        row.push(currentField.trim());
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
                row.push(currentField.trim());
                if (row.length === headers.length) {
                    const entry = {};
                    headers.forEach((header, index) => {
                        let value = row[index];
                        if (value.startsWith('"') && value.endsWith('"')) value = value.substring(1, value.length - 1);
                        entry[header] = value.replace(/""/g, '"');
                    });
                    data.push(entry);
                }
            }
            return data;
        }

        function renderMedia(mediaItems) {
            mediaContainer.innerHTML = ''; 
            noResultsMessage.classList.toggle('hidden', mediaItems.length === 0);
            mediaItems.forEach(item => {
                const posterUrl = item['Poster Link'] || '';
                const cardElement = document.createElement('div');
                cardElement.addEventListener('click', () => showDetailsModal(item));
                if (posterUrl) {
                    cardElement.className = 'group relative aspect-[2/3] bg-gray-900 rounded-lg overflow-hidden shadow-lg transition-all duration-300 ease-in-out cursor-pointer hover:scale-105 hover:shadow-2xl';
                    const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodeURIComponent(item.Title || '').replace(/'/g, '%27')}`;
                    cardElement.innerHTML = `
                        <img src="${posterUrl}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="Poster for ${item.Title}" class="w-full h-full object-cover transition-all duration-300 group-hover:brightness-50">
                        <div class="absolute inset-0 p-4 flex flex-col justify-end bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <h2 class="text-xl font-bold text-white mb-1">${item.Title || 'Untitled'}</h2>
                            <p class="text-sm text-gray-300">${item.Year || ''}</p>
                        </div>`;
                } else {
                    cardElement.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 ease-in-out flex flex-col cursor-pointer aspect-[2/3]';
                    const typeColor = {'Movie': 'bg-indigo-900/50', 'Book': 'bg-emerald-900/50', 'TV Show': 'bg-sky-900/50', 'Video Game': 'bg-rose-900/50', 'default': 'bg-gray-800'}[item.Type] || 'bg-gray-800';
                    let creatorLabel = 'Creator';
                    let creatorName = item.Creator || 'Unknown';
                    if (item.Type?.toLowerCase() === 'movie') {
                        creatorLabel = 'Director(s)';
                        creatorName = item['Director(s)'] || item['Director'] || item.Creator || 'Unknown';
                    } else if (item.Type?.toLowerCase() === 'book') {
                        creatorLabel = 'Author';
                    }
                    cardElement.innerHTML = `
                        <div class="p-5 flex-grow flex flex-col justify-center">
                            <h2 class="text-xl font-bold text-white mb-2 flex-grow">${item.Title || 'Untitled'}</h2>
                            <p class="text-gray-400 mb-1"><span class="font-semibold">${creatorLabel}:</span> ${creatorName}</p>
                            <div class="mt-4 flex flex-wrap gap-2">
                                ${item.Genre ? `<span class="text-xs font-semibold text-gray-300 bg-gray-700 px-2 py-1 rounded-full">${item.Genre}</span>` : ''}
                                ${item.Year ? `<span class="text-xs font-semibold text-gray-300 bg-gray-700 px-2 py-1 rounded-full">${item.Year}</span>` : ''}
                            </div>
                        </div>
                        <div class="px-5 py-3 ${typeColor}"><p class="text-sm font-semibold text-white">${item.Type || 'Media'}</p></div>`;
                }
                mediaContainer.appendChild(cardElement);
            });
        }
        
        function showDetailsModal(item) {
            const posterUrl = item['Poster Link'] || '';
            const encodedTitle = encodeURIComponent(item.Title || '').replace(/'/g, '%27');
            const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodedTitle}`;
            let creatorLabel = 'Creator';
            let creatorName = item.Creator || 'Unknown';
            if (item.Type?.toLowerCase() === 'movie') {
                creatorLabel = 'Director(s)';
                creatorName = item['Director(s)'] || item['Director'] || item.Creator || 'Unknown';
            } else if (item.Type?.toLowerCase() === 'book') {
                creatorLabel = 'Author';
            }
            modalContent.innerHTML = `
                <button id="close-details-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl z-10"><i class="fa-solid fa-xmark"></i></button>
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-1/3 p-4"><img src="${posterUrl}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="Poster for ${item.Title}" class="w-full h-auto rounded-lg shadow-lg"></div>
                    <div class="md:w-2/3 p-6 flex flex-col">
                        <h2 class="text-3xl font-bold text-white mb-2">${item.Title} (${item.Year || 'N/A'})</h2>
                        <div class="flex flex-wrap gap-x-4 gap-y-2 text-gray-400 mb-4">
                            ${item.Type ? `<span><i class="fa-solid fa-film mr-2"></i>${item.Type}</span>` : ''}
                            ${item.Genre ? `<span><i class="fa-solid fa-tag mr-2"></i>${item.Genre}</span>` : ''}
                            ${item['Audience Rating'] ? `<span><i class="fa-solid fa-star mr-2"></i>${item['Audience Rating']}</span>` : ''}
                            ${item.Country ? `<span><i class="fa-solid fa-flag mr-2"></i>${item.Country}</span>` : ''}
                        </div>
                        <div class="space-y-2 text-lg mb-4">
                            <p><span class="font-semibold">${creatorLabel}:</span> ${creatorName}</p>
                            ${item['Writer(s)'] ? `<p><span class="font-semibold">Writer(s):</span> ${item['Writer(s)']}</p>` : ''}
                            ${item['Actor(s)'] ? `<p><span class="font-semibold">Actor(s):</span> ${item['Actor(s)']}</p>` : ''}
                        </div>
                        <div class="text-gray-300 flex-grow mb-4"><h3 class="font-semibold text-white text-xl mb-2">Summary</h3><p>${item['Summary'] || 'No summary available.'}</p></div>
                        ${item['Trailer Link'] ? `<button id="view-trailer-btn" class="mt-auto inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-center w-full"><i class="fa-brands fa-youtube mr-2"></i>View Trailer</button>` : ''}
                    </div>
                </div>`;
            document.body.style.overflow = 'hidden';
            detailsModal.classList.remove('hidden');
            setTimeout(() => {
                detailsModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
            document.getElementById('close-details-btn').addEventListener('click', hideDetailsModal);
            const trailerButton = document.getElementById('view-trailer-btn');
            if (trailerButton) trailerButton.addEventListener('click', () => showTrailerModal(item['Trailer Link']));
        }

        function hideDetailsModal() {
            document.body.style.overflow = '';
            detailsModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => detailsModal.classList.add('hidden'), 250);
        }

        function getYoutubeVideoId(url) {
            if (!url) return null;
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function showTrailerModal(trailerUrl) {
            const videoId = getYoutubeVideoId(trailerUrl);
            if (!videoId) { alert('Invalid YouTube URL provided.'); return; }
            trailerVideoContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            trailerModal.classList.remove('hidden');
            setTimeout(() => trailerModal.classList.remove('opacity-0'), 10);
        }

        function hideTrailerModal() {
            trailerModal.classList.add('opacity-0');
            setTimeout(() => {
                trailerModal.classList.add('hidden');
                trailerVideoContainer.innerHTML = '';
            }, 250);
        }

        function populateFilterDropdown(element, getValues, label) {
            const values = ['All', ...new Set(getValues())].sort();
            element.innerHTML = `<option value="All">${label}</option>` + values.slice(1).map(value => `<option value="${value}">${value}</option>`).join('');
        }

        function populateFeaturedSlider() {
            const featuredItems = allMediaData
                .filter(item => (item.Type === 'Movie' || item.Type === 'TV Show') && item['Poster Link'])
                .sort(() => 0.5 - Math.random()) // Shuffle the array
                .slice(0, SLIDER_ITEM_COUNT);

            if (featuredItems.length < 5) { // Only show slider if there are enough items
                featuredSlider.classList.add('hidden');
                return;
            }

            featuredSlider.classList.remove('hidden');
            let sliderHTML = '';
            featuredItems.forEach(item => {
                const placeholderUrl = `https://placehold.co/400x600/1f2937/d1d5db?text=${encodeURIComponent(item.Title || '').replace(/'/g, '%27')}`;
                sliderHTML += `
                    <div class="flex-shrink-0 w-44 h-full mx-2 cursor-pointer group" onclick="showDetailsModal(allMediaData.find(i => i.Title === '${item.Title.replace(/'/g, "\\'")}'))">
                        <img src="${item['Poster Link']}" onerror="this.onerror=null;this.src='${placeholderUrl}';" alt="${item.Title}" class="w-full h-full object-cover rounded-lg transition-transform duration-300 group-hover:scale-105">
                    </div>
                `;
            });

            // Duplicate the content for a seamless loop
            sliderTrack.innerHTML = sliderHTML + sliderHTML;
            // Adjust animation duration based on content
            sliderTrack.style.animationDuration = `${featuredItems.length * 5}s`;
        }

        function applyFiltersAndSort() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeFilter = typeFilterDropdown.value;
            const genreFilter = genreFilterDropdown.value;
            const sortValue = sortSelect.value;
            
            let processedData = allMediaData
                .filter(item => searchTerm ? Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm)) : true)
                .filter(item => typeFilter !== 'All' ? item.Type === typeFilter : true)
                .filter(item => genreFilter !== 'All' ? item.Genre?.split(',').map(g => g.trim()).includes(genreFilter) : true);

            switch (sortValue) {
                case 'title-asc': processedData.sort((a, b) => (a.Title || '').localeCompare(b.Title || '')); break;
                case 'title-desc': processedData.sort((a, b) => (b.Title || '').localeCompare(a.Title || '')); break;
                case 'year-desc': processedData.sort((a, b) => (b.Year || 0) - (a.Year || 0)); break;
                case 'year-asc': processedData.sort((a, b) => (a.Year || 0) - (b.Year || 0)); break;
            }
            renderMedia(processedData);
        }

        function resetAll() {
            searchInput.value = '';
            typeFilterDropdown.value = 'All';
            genreFilterDropdown.value = 'All';
            sortSelect.value = 'default';
            applyFiltersAndSort();
        }

        async function initialize() {
            mediaContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Fetching media data...</p>';
            try {
                const response = await fetch(`${CSV_URL}&_=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
                const csvText = await response.text();
                allMediaData = parseCSV(csvText);
                
                populateFilterDropdown(typeFilterDropdown, () => allMediaData.map(item => item.Type).filter(Boolean), 'All Types');
                populateFilterDropdown(genreFilterDropdown, () => allMediaData.flatMap(item => item.Genre?.split(',') || []).map(g => g.trim()).filter(Boolean), 'All Genres');
                populateFeaturedSlider();
                
                lastUpdatedSpan.textContent = new Date().toLocaleString('en-AU', { dateStyle: 'medium', timeStyle: 'short' });
                applyFiltersAndSort();
            } catch (error) {
                console.error('Failed to fetch or parse media data:', error);
                mediaContainer.innerHTML = `<p class="text-red-400 col-span-full text-center">Error: Could not load media data. Please check the console for details.</p>`;
                lastUpdatedSpan.textContent = 'Failed to load';
            }
        }

        // --- EVENT LISTENERS ---
        [searchInput, typeFilterDropdown, genreFilterDropdown, sortSelect].forEach(el => el.addEventListener('input', applyFiltersAndSort));
        resetButton.addEventListener('click', resetAll);
        detailsModal.addEventListener('click', e => { if (e.target === detailsModal) hideDetailsModal(); });
        document.getElementById('close-trailer-btn').addEventListener('click', hideTrailerModal);
        trailerModal.addEventListener('click', e => { if (e.target === trailerModal) hideTrailerModal(); });
        document.addEventListener('DOMContentLoaded', initialize);

    </script>

</body>
</html>
